<?php
/**
 * YAWIK
 *
 * @filesource
 * @license MIT
 * @copyright  2013 - 2018 Cross Solution <http://cross-solution.de>
 *
 * Variables:
 *             $job         JobInterface    Job Entity
 *             $isVisited   bool            Has the user already visited this job in the current session
 */

// check for preview
$routeParams = $this->params()->fromRoute();
$preview = false;
if (isset($routeParams['isPreview']) && $routeParams['isPreview']) {
    $preview = true;
}
if ($this->isIntern):
         $this->headMeta()->setName('robots', 'index,follow');
//  elseif(!$this->isIntern):
elseif(!$this->isIntern && !$this->isEmbeddable):
          $this->headMeta()->setName('robots', 'noindex,nofollow');
endif;

$container = new \Zend\Session\Container('gastro24_jobboardcontainer');
$lastSearchQuery = $container->landingPageSearchQuery;
$searchTerm = $container->searchTerm;

if (!$lastSearchQuery) {
    $lastSearchQueryUrl = ($container->fromCompanyProfile) ? '/de/jobs?clear=1' : $this->url('lang/jobboard', [], ['query'=> ['q' => $searchTerm]], true);
    $backTitle = $this->translate('Back to search');
}
else {
    // TODO: move to helper or plugin
    // format $lastSearchQuery
    $search = array("Ä", "Ö", "Ü", "ä", "ö", "ü", "ß", "´");
    $replace = array("Ae", "Oe", "Ue", "ae", "oe", "ue", "ss", "");
    $lastSearchQuery = trim($lastSearchQuery, '"');
    $originalSearchQuery = $lastSearchQuery;
    $lastSearchQuery = str_replace($search, $replace, $lastSearchQuery);
    $lastSearchQuery = strtolower(preg_replace('/[^A-Za-z0-9\-]/', '-', $lastSearchQuery));

    $lastSearchQueryUrl = $this->url('lang/landingPage', ['q' => $lastSearchQuery, 'format' => 'html' ], true);
    $backTitle = $this->translate($originalSearchQuery . ' Jobs');
}

// banner image
if (!$this->isIntern && $this->isEmbeddable) {
    if (!$hasBanner) {
        $imageServerUrl = $this->basePath('modules/Gastro24/images/bg_placeholder_blue.svg');
    }
}

// get date difference
$today = new DateTime();
if ($job->getDatePublishStart()) {
    $dayDiff = $today->diff($job->getDatePublishStart());
    $publishDate = ($dayDiff->d == 0) ? $this->dateFormat($job->getDatePublishStart(), 'medium', 'none') :
        $this->translate('vor ' . $dayDiff->d . ' Tagen');
}elseif($job->getDateCreated()) {
    $dayDiff = $today->diff($job->getDateCreated());
    $publishDate = ($dayDiff->d == 0) ? $this->dateFormat($job->getDateCreated(), 'medium', 'none'):
        $this->translate('vor ' . $dayDiff->d . ' Tagen');
}

// get logo url
$defaultLogoUrl = $this->basePath('modules/Gastro24/images/no-company-logo.png');
$logoUrl = $this->gastroLogoUri($this->job);
if (!$logoUrl) {
    $logoUrl = $defaultLogoUrl;
}
//$this->headTitle($this->job->getTitle());

$this->headTitle($this->job->getTitle()." von ".$this->jobOrganizationName($this->job));


$link = $this->job->getLink();

//if (!$link) {
//    $link = $this->jobUrl($job, ['preview' => true, 'linkOnly' => true]);
//    $this->isEmbeddable = true;
//}

if (!$this->isIntern && !$this->isVisited && !$this->isEmbeddable):
$this->headScript()->captureStart();?>
;(function($, w) {
    $(function() {
        w.setTimeout(
            function() { w.location.href='<?=$this->job->getLink()?>'; },
            3000
        );
    });
})(jQuery, window);
<?php $this->headScript()->captureEnd();
endif;

$this->headScript()->appendFile($this->basePath('modules/Gastro24/jobs.js'))
    ->appendFile($this->basePath('/dist/js/bootstrap-dialog.min.js'))
    ->appendFile($this->basePath('/dist/js/iframeResizer.js'))
    ->appendFile($this->basePath('/dist/js/iframeResizer.contentWindow.min.js'));

// organisation values
$org = $job->getOrganization();
$orgIsDisabled = false;
$orgName = $this->jobOrganizationName($this->job);
if ($org && (Organizations\Entity\Organization::PROFILE_DISABLED == $org->getProfileSetting() || is_null($org->getProfileSetting()) )) {
    $orgIsDisabled = true;
}
?>

<!-- prev / next navigation -->
<?php if (!$preview) : ?>
<div class="row job-navigation">
    <div class="col-md-3">
        <a title="<?= $backTitle ?>"
           href="<?= $lastSearchQueryUrl ?>"
           class="btn btn-default btn-block company-jobs-btn">
            <i class="fa fa-chevron-left"></i> <?= $backTitle ?>
        </a>
    </div>
    <div class="col-md-4 col-md-offset-5">
        <span <?php if(!$this->prevJob || !$this->nextJob) echo 'class="reverse"' ?>>
            <?php if($this->prevJob) : ?>
            <a title="<?= $this->prevJob->getTitle() ?>"
               href="<?= $this->jobUrl($this->prevJob, ['linkOnly' => true ]) ?>"
               class="btn btn-default">
                <i class="fa fa-chevron-left"></i><?= $this->translate('Previous Job') ?>
            </a>
            <?php endif; ?>

            <?php if($this->nextJob) : ?>
            <a title="<?= $this->nextJob->getTitle() ?>"
               href="<?= $this->jobUrl($this->nextJob, ['linkOnly' => true ]) ?>"
               class="btn btn-default">
                <?= $this->translate('Next Job') ?><i class="fa fa-chevron-right right-align"></i>
            </a>
            <?php endif; ?>
        </span>
    </div>
</div>
<?php endif; ?>
<!-- end prev / next navigation -->


<div class="row">
 <div class="col-md-12">
    <?php if (!$this->isIntern && $this->isVisited && !$this->isEmbeddable): ?>
         <div class="panel panel-default">
             <div class="panel-body">
                <p> Sie haben sich diese Stellenanzeige bereits angesehen.</p>
                <p><a style="text-decoration:underline" href="<?=$this->job->getLink()?>">&raquo; Direkt zum Inserat</a></p>
             </div>
         </div>
    <?php elseif (!$this->isIntern && !$this->isEmbeddable): ?>
                    
        <style>

     .spinner {
      margin: 0 auto;
      width: 70px;
      text-align: center;
    }

    .spinner > div {
      width: 18px;
      height: 18px;
      background-color: #333;

      border-radius: 100%;
      display: inline-block;
      -webkit-animation: sk-bouncedelay 1.4s infinite ease-in-out both;
      animation: sk-bouncedelay 1.4s infinite ease-in-out both;
    }

    .spinner .bounce1 {
      -webkit-animation-delay: -0.32s;
      animation-delay: -0.32s;
    }

    .spinner .bounce2 {
      -webkit-animation-delay: -0.16s;
      animation-delay: -0.16s;
    }

    @-webkit-keyframes sk-bouncedelay {
      0%, 80%, 100% { -webkit-transform: scale(0) }
      40% { -webkit-transform: scale(1.0) }
    }

    @keyframes sk-bouncedelay {
      0%, 80%, 100% {
        -webkit-transform: scale(0);
        transform: scale(0);
      } 40% {
        -webkit-transform: scale(1.0);
        transform: scale(1.0);
      }
    }

    </style>
        <div class="panel panel-default">
        <div class="panel-body">
            <div class="spinner">
                <div class="bounce1"></div>
                <div class="bounce2"></div>
                <div class="bounce3"></div>
             </div>
             <br /><br />
             <p style="text-align:center;">Sie werden in Kürze automatisch auf das Job-Inserat von <?=$orgName?> weitergeleitet...</p>
        </div>
    </div>
    <?php endif ?>

<!-- not intern and embedded -->
<?php if (!$this->isIntern && $this->isEmbeddable):?>

    <style>
    #preload {
        background-color:#fff;
        padding:100px 0;
    }
    .frame-content {
        width: 100%;
    }
    .frame-content iframe {

        background-color:#fff;
        /*width:100%;*/
        /*height:1800px;*/
        /*overflow:auto;*/
    }
    iframe {
        width: 1px;
        min-width: 100%;
    }
       .spinner {
      margin: 0 auto;
      width: 70px;
      text-align: center;
    }

    .spinner > div {
      width: 18px;
      height: 18px;
      background-color: #333;

      border-radius: 100%;
      display: inline-block;
      -webkit-animation: sk-bouncedelay 1.4s infinite ease-in-out both;
      animation: sk-bouncedelay 1.4s infinite ease-in-out both;
    }

    .spinner .bounce1 {
      -webkit-animation-delay: -0.32s;
      animation-delay: -0.32s;
    }

    .spinner .bounce2 {
      -webkit-animation-delay: -0.16s;
      animation-delay: -0.16s;
    }

    @-webkit-keyframes sk-bouncedelay {
      0%, 80%, 100% { -webkit-transform: scale(0) }
      40% { -webkit-transform: scale(1.0) }
    }

    @keyframes sk-bouncedelay {
      0%, 80%, 100% {
        -webkit-transform: scale(0);
        transform: scale(0);
      } 40% {
        -webkit-transform: scale(1.0);
        transform: scale(1.0);
      }
    }

    </style>


    <script type="text/javascript">
    $(function(){
        var d=15,
            a=$("#preload").removeClass("hidden"),
            e=$(".frame-content iframe").addClass("hidden"),
            c=$(window),
            g=$("header"),
            f=$("footer"),
            b=$(".box.intro");

        setTimeout(function(){
            a.addClass("hidden");
            e.removeClass("hidden");
        },3000);

        c.resize(function(){
            e.height(c.height()-g.outerHeight(true)-f.outerHeight(true)-b.outerHeight(true)-d)
        }).resize()});
    </script>
  
    <div class="panel panel-default hidden-sm hidden-md hidden-lg text-center">
        <div class="panel-body">
              <a href="<?=$this->job->getLink()?>">&raquo; Direkt zum Inserat</a>
        </div>
    </div>

    <div class="panel panel-default panel__job-detail">
         <!-- Bannerbild -->
         <div class="banner" style="background-image: url(<?= $imageServerUrl ?>)"></div>
         <!-- End Bannerbild -->

        <div class="panel-body">
            <!-- company logo and job title-->
            <div class="teaser__job-detail">
                <div itemprop="logo">
                    <div class="wrapper__logo">
                        <img src="<?= $logoUrl ?>" alt="<?= $orgName?>">
                    </div>
                </div>
                <h1><?=$job->getTitle()?></h1>
            </div>
            <!-- end company logo and job title-->

            <div class="job-short-info">
                <ul>
                    <li class="location">
                        <!-- location -->
                        <?php
                        $location = $job->getLocations()->current();
                        echo $location ? $location->getCity() : preg_replace('~\(.*?\)$~', '', (string) $job->getLocation());
                        ?>
                        <!-- end location -->
                    </li>
                    <li class="company">
                        <!-- company name -->
                        <?php if ($org && !$orgIsDisabled): ?>
                            <a title="Jobs <?= $orgName ?>" href="<?= $this->orgProfileUrl($org)?>?clear=1"><?= $orgName ?></a>
                        <?php else: ?>
                            <strong><?= $orgName ?></strong>
                        <?php endif ?>
                        <!-- end company name -->
                    </li>
                    <li class="type">
                        <!-- type of contract -->
                        <?php
                        $typeOfContract = $job->getClassifications()->getEmploymentTypes()->__toString() ?:'Vollzeit' ?>
                        <span class="yk-contract yk-<?=$typeOfContract?>"><?=$typeOfContract; ?></span>
                        <!-- end type of contract -->
                    </li>
                    <li class="date">
                        <!-- published date -->
                        <span><?= $publishDate ?></span>
                        <!-- end published date -->
                    </li>
                </ul>
            </div>

            <hr class="job-details-devider"/>

            <!-- apply button -->
            <?php if($preview): ?>
                <div class="button-job-apply text-center">
                    <span class="btn btn-primary internal-apply-link"><?= $this->translate('Jetzt bewerben') ?></span>
                </div>
            <?php else: ?>
                <div class="button-job-apply text-center">
                    <?=$this->gastroApplyUrl($job);?>
                </div>
            <?php endif; ?>
            <!-- end apply button -->

            <div class="embed-container">
                <div class="hidden-xs frame-content">
                    <div id="preload" class="loading hidden text-center">
                        <div class="spinner">
                            <div class="bounce1"></div>
                            <div class="bounce2"></div>
                            <div class="bounce3"></div>
                        </div>
                        <p>Das Inserat wird geladen, bitte haben Sie einem Moment Geduld</p>
                    </div>
                    <iframe style="height:2500px" id="iframe4" src="<?=$link?>"></iframe>
                </div>
            </div>

            <!-- apply button -->
            <?php if($preview): ?>
                <div class="button-job-apply text-center">
                    <span class="btn btn-primary internal-apply-link"><?= $this->translate('Jetzt bewerben') ?></span>
                </div>
            <?php else: ?>
                <div class="button-job-apply text-center">
                    <?=$this->gastroApplyUrl($job);?>
                </div>
            <?php endif; ?>
            <!-- end apply button -->

            <hr class="job-details-devider"/>

            <!-- share buttons -->
            <div>Diesen Job teilen: </div>
            <div id="share" class="pull-left round-shares"></div>
            <div class="clearfix"></div>
            <!-- end share buttons -->

            <?php if (!$preview): ?>
                <!-- recommended jobs
                <div class="grey-description-container">
                    <div class="content">
                        <div class="headline">Empfohlene Jobs</div>
                        <div class="content__inner">
                          
                        </div>
                    </div>
                </div>
                end recommended jobs -->

                <!-- recommended jobs by cities
                <div class="grey-description-container">
                    <div class="content">
                        <div class="headline">Jobs nach Städten</div>
                        <div class="content__inner">
                           
                        </div>
                    </div>
                </div>
                 end recommended jobs by cities -->
            <?php endif; ?>
        </div>
    </div>

    <!-- socials -->
    <script src="/modules/Gastro24/jssocials-1.4.0/dist/jssocials.js"></script>
    <script>
    $("#share").jsSocials({
        showLabel: false,
        showCount: true,
        shares: ["email", "twitter", "facebook", "whatsapp"]
    });
    </script>
    <!-- end socials -->

     <!-- iframe resizer -->
    <script>
        iFrameResize({ log: false }, '#iframe4')
    </script>
     <!-- end iframe resizer -->

      </div>
</div>

     
 
<?php endif; ?>





<?php if ($this->isIntern):?>
    <?=$this->internalJob?>
<?php endif ?>



  
<div class="modal fade" id="job-apply-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
    <div class="modal-dialog" style="width: 90%; max-width:1200px; height: 90%" role="document">
        <div class="modal-content" style="height: 100%">
            <div class="modal-body" style="height: calc(100% - 65px)">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Schliessen</button>
            </div>
        </div>
    </div>
