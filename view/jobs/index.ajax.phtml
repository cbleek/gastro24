<?php
/**
 * YAWIK
 *
 * @filesource
 * @copyright (c) 2013 - 2016 Cross Solution (http://cross-solution.de)
 * @license   MIT
 */

// We only want to render something, if there are items.
if (count($jobs)): ?>
    <div class="hidden" id="update-job-count">
        <?=$this->jobs->getTotalItemCount()?>
    </div>

<?php
$hasFacets = $jobs instanceof \Solr\FacetsProviderInterface;
$queryGet = $this->params()->fromQuery();
unset($queryGet['clear']);
$query = $this->params()->fromRoute('wpId') ?: (count($queryGet) ? 0 : 304);
$wordpress = $this->proxy('wordpress');
$searchTerm = (isset($queryGet['q']) && is_string($queryGet['q'])) ? trim($queryGet['q'],'"') : null;
$hasRegion= isset($queryGet['region_MultiString']);

$this->headMeta()->setName('description', $wordpress->chain(['page' => $query, 'value' => 'meta-fields.description'], ''));
$this->headScript()->appendFile($this->basePath($this->asset('modules/Gastro24/jssocials-1.4.0/dist/jssocials.js')));

//$this->headMeta()->setName('keywords', $wordpress->call('value', ['meta-fields.keywords'], ''));
$description = $wordpress->call('value', ['content.rendered'], '');
$wordpressTitle = '';


if ($this->params()->fromRoute('isLandingPage')) {
    $wordpressTitle = $wordpress->call('value', ['title.rendered'], '');
    $descriptionText = 'Aktuell ' . $this->jobs->getTotalItemCount() . ' verfügbare ' .
        $wordpressTitle . ' finden auf Gastrojob24.ch, der Gastronomie & Hotellerie Jobbörse der Schweiz.';
    if ($this->jobs->getTotalItemCount() == 1) {
        $descriptionText = 'Aktuell ' . $this->jobs->getTotalItemCount() . ' verfügbaren ' .
            $wordpressTitle . ' finden auf Gastrojob24.ch, der Gastronomie & Hotellerie Jobbörse der Schweiz.';
    }
    
    
    $titleOgText = $this->jobs->getTotalItemCount() . ' ' . $wordpressTitle . ' verfügbar - Gastrojob24.ch.';
    $descriptionOgText = 'Jetzt Traumjob finden aus ' . $this->jobs->getTotalItemCount() . ' ' . $wordpressTitle . ' bei Gastrojob24.ch - der Gastronomie & Hotellerie Jobbörse der Schweiz.';
    $this->headMeta()->setName('description', $descriptionText)
        ->setProperty('og:title', $titleOgText)
        ->setProperty('og:description', $descriptionOgText)
        ->setProperty('og:url', 'https://www.gastrojob24.ch' . $this->url('lang/landingPage', ['q' => $this->params()->fromRoute('term'), 'format' => 'html'], true))
        ->setProperty('og:image', 'https://www.gastrojob24.ch/modules/Gastro24/gastro-logo-fb.png')
        ->setProperty('og:locale', 'de_DE')
        ->setProperty('og:type', 'website')
        ->setAutoEscape(false);
}

$container = new \Zend\Session\Container('gastro24_jobboardcontainer');
$container->fromCompanyProfile = false;
$container->searchTerm = $searchTerm;

$savedJobsContainer = new \Zend\Session\Container('gastro24_savedjobs');
$defaultLogoUrl = $this->basePath('modules/Gastro24/images/no-company-logo.png');
$jobsRepo = $this->services('repositories')->get('Jobs');
?>

<style>
  @media (min-width: 992px) {
    .collapse.dont-collapse-sm {
      display: block;
      height: auto !important;
      visibility: visible;
    }
  }
 .yk-pagination ul>li>a, .yk-pagination ul>li>span {
    padding: 10px 15px;
    margin: 0 5px;
    font-size: 16px;
    line-height: 24px;
     
 } 
  .panel-default>.panel-heading+.panel-collapse>.panel-body label {
    font-weight:normal!important
  }
 .active-searchterm:first-letter {
     text-transform:capitalize;
 }
 
 .well-sm {
     
    padding: 0;
    background: none;
    border: none;
    box-shadow: none;
    -webkit-box-shadow:none;
    margin-bottom: 10px;
 }
 
.facet-active {
    
    margin: 0px 5px 5px 0px;
    background-color: #dcdfe2;
    color: #566578;
    padding: 3px 30px 3px 10px;
    font-size: 14px;
    line-height: 24px;
    border-color: #dcdfe2;
    border-radius: 0;
    position: relative;
    text-decoration: none;

}

.facet-active span {
    
    font-size: 24px;
    position: absolute;
    right: 10px;
    top: 4px;
}
 
.facet-reset {
    padding: 0;
    display: block;
    margin-top: 5px;
    text-decoration: underline;
    
}
   
 
 
</style>

<?php if ($hasFacets):
    if ($this->params()->fromRoute('isLandingPage')):?>
        <span class="facets-url" data-url="<?=$this->url('lang/landingPage', ['q' => $this->params()->fromRoute('term'), 'format' => 'html'], true)?>"></span>
    <?php endif;
    $facets = $jobs->getFacets();
    $activeFacets = $facets->getActiveValues();
?>
<?php endif;?>

<div class="row">
    <div class="col-md-12">

        <!-- breadcrumbs -->
        <?= $this->partial('jobs/partials/breadcrumbs.phtml', [
            'searchTerm' => $searchTerm,
            'hasRegion' => $hasRegion,
            'wordpressTitle' => $wordpressTitle
        ]); ?>
        <!-- breadcrumbs -->

        <div class="page-title">
             <span><?=$this->jobs->getTotalItemCount() ?> </span>
             <h1><?=$wordpress->call('value', ['title.rendered'], '') ?: (count($this->jobs) ? 'Job-Treffer' : 'Leider keine passenden Jobs gefunden'); ?>
        </div>

        <div class="row job-results-container">


     <div class="col-md-3">
         
         
       <!-- list active filters -->
        <?php if ($activeFacets):?>
            <div class="well well-sm hidden-xs">
              <!--  <?=$this->translate('Active filters:')?>-->
             
              
                <?php foreach ($activeFacets as $facetName => $facetValues):?>
                    <?php foreach ($facetValues as $facetValue):?>
                        <button type="button" class="btn btn-primary btn-sm facet-active" data-name="<?=$this->escapeHtmlAttr($facetName)?>[<?=$this->escapeHtmlAttr($facetValue)?>]" title="<?=$this->translate('Remove filter')?>"><?=$facetValue?> <span>&times;</span></button>
                    <?php endforeach;?>
                <?php endforeach;?>
            
                 <p>Sie können Ihre Jobsuche weiter einschränken, indem Sie unten ein oder mehrere Filterkriterien auswählen.</p>
                <button type="button" class="btn btn-link facet-reset"><?=$this->translate('Remove all filters')?></button>
            </div>
        <?php endif;?>
        <!-- end list active filters -->
        
         <!-- filter -->
            <div class="panel-group collapse dont-collapse-sm hidden-xs">
            <?php $facetsHtml = ''; $isFirstFacet = true; $atLeastOneTotalActive = false; foreach ($facets as $facetName => $facetValues):?>
                <?php if(count($facetValues)>0): $atLeastOneActive = false; $facetsList = []; ob_start();?>
                <div id="facets-box-<?=$facetName?>" class="panel panel-default">
                    <div class="panel-heading">
                        <a class="<?=$isFirstFacet ?  '%firstCollapsed% ' : '%collapsed%'?>" style="display:block;width: 100%;text-decoration:none;" data-toggle="collapse" data-parent="#facets-box-<?=$facetName?>" href="#facets-box-<?=$facetName?>-content">
                        <?=$this->translate($facets->getTitle($facetName))?>
                            <span class="small">%facetsList%</span>
                        </a>

                    </div>
                    <div id="facets-box-<?=$facetName?>-content" class="panel-collapse collapse <?=$isFirstFacet ? '%firstIn%' : '%in%' ?>">
                    <div class="panel-body">
                        <?php foreach ($facetValues as $facetValue => $facetValueCount):
                            $activeFacet = $facets->isValueActive($facetName, $facetValue);
                            $atLeastOneActive = $atLeastOneActive || $activeFacet;?>
                            <div>
                                <label<?=$activeFacet ? ' class="text-primary"' : ''?>>
                                    <input type="checkbox" name="<?=$this->escapeHtmlAttr($facetName)?>[<?=$this->escapeHtmlAttr($facetValue)?>]"
                                           class="facet-checkbox"<?=$activeFacet?" checked":""?>>
                                    <?=$facetValue?> (<?=$facetValueCount?>)
                                </label>
                            </div>
                        <?php if ($activeFacet): $facetsList[] = $facetValue; endif; endforeach;?>
                    </div>
                    </div> <!-- facets-collaps-* -->
                </div>
                <?php $facetsHtml .= str_replace(
                        ['%in%', '%firstIn%', '%firstCollapsed%', '%collapsed%', '%facetsList%' ],
                        [
                                $atLeastOneActive ? 'in' : '',
                                $atLeastOneActive ? 'in' : '%firstIn%',
                                $atLeastOneActive ? '' : '%firstCollapsed%',
                                $atLeastOneActive ? '' : 'collapsed',
                                join(', ', $facetsList),
                        ],
                        ob_get_clean()
                    ); $atLeastOneTotalActive = $atLeastOneTotalActive || $atLeastOneActive; endif; $isFirstFacet = false;?>
            <?php endforeach;
                echo str_replace(
                        ['%firstCollapsed%', '%firstIn%'],
                        [$atLeastOneTotalActive ? 'collapsed' : '', $atLeastOneTotalActive ? '' : 'in'],
                        $facetsHtml
                );
            ?>
        </div>
        </div>

            <!-- result list -->
            <div class="col-md-9 job-overview-results">

                <?=$this->proxy('jobsByMailSubscriptionForm')->render($jobs)?>

                <div class="row">
                    <div class="row-eq-height">
                        <?php
                            // get date difference
                            $today = new DateTime();
                        ?>
                        <?php foreach ($jobs as $index => $job): ?>
                            <?php
                                $org = $job->getOrganization();
                                $hasJobTemplate = $this->gastroJobTemplate($org);
                                $isIntern = (!$job->getLink() || $hasJobTemplate);
                                $isEmbeddable = $this->gastroIsEmbeddable($job->getLink());
                                $jobHasExternLink = (!$isIntern && !$isEmbeddable);
                                $industries = $job->getClassifications()->getIndustries();
                                $orgName = $this->jobOrganizationName($job);

                                // TODO: remove workaround with repo after yawik/solr Update
                                $jobObject = $jobsRepo->find($job->getId());
                                $template = $jobObject->getAttachedEntity('gastro24-template');

                                $isExpired = ($job->getStatus()) ? $job->getStatus()->getName() == \Jobs\Entity\StatusInterface::EXPIRED : false;
                                $orgIsDisabled = false;
                                if ($org && (Organizations\Entity\Organization::PROFILE_DISABLED == $org->getProfileSetting() || is_null($org->getProfileSetting())) ) {
                                    $orgIsDisabled = true;
                                }
                                $href = ($jobHasExternLink) ? $job->getLink() : $this->jobUrl($job, ['linkOnly' => true, 'absolute' => true ]);
                            ?>
                            <div class="col-md-12 col-sm-6 col-xs-12">
                                <div class="featured-image-box">
                                    <?php
                                        // check for newer than 24 hoursj
                                        $jobDate = $job->getDatePublishStart() ?? $job->getDateCreated();
                                        $dayDiff = $today->diff($jobDate);
                                        if ($dayDiff->days < 1) {
                                            echo '<div class="corner"><span>NEU</span></div>';
                                        }
                                    ?>

                                    <div class="content-area">
                                        <div class="top-cnt">

                                            <div class="box__job-favorite">
                                                <h2 class="h3" style="margin-top: 0;margin-bottom: 10px;">
                                                    <?php if($jobHasExternLink) { ?>
                                                        <a style="color:#243b84" title="<?=strip_tags($job->getTitle())?>" rel="nofollow noopener sponsored" target="_blank"
                                                           href="<?=$href?>"><?=strip_tags($job->getTitle())?>

                                                           <i style="padding-left:5px" class="fa fa-external-link"></i>
                                                        </a>
                                                    <?php }
                                                    else { ?>
                                                        <a style="color:#243b84" title="<?=strip_tags($job->getTitle())?>"
                                                           href="<?=$href?>"><?=strip_tags($job->getTitle())?>
                                                        </a>
                                                    <?php } ?>
                                                </h2>
                                            </div>

                                            <div class="box__job-short-info">
                                                <ul>
                                                    <li class="location">
                                                        <!-- location -->
                                                        <?php
                                                        $location = $job->getLocations()->last();
                                                        if ($location == '') {
                                                            $locationString = $this->translate('Swiss');
                                                        }
                                                        elseif ($location) {
                                                            $locationString = $location->getCity() ? $location->getCity() :
                                                                preg_replace('~\(.*?\)$~', '', (string) $job->getLocation());
                                                        }
                                                        else {
                                                            $locationString = preg_replace('~\(.*?\)$~', '', (string) $job->getLocation());
                                                        }
                                                        ?>
                                                        <?=$locationString ?>
                                                        <!-- end location -->
                                                    </li>
                                                    <li class="company">
                                                        <!-- company name -->
                                                        <?php if ($org && !$orgIsDisabled): ?>
                                                            <a title="Jobs <?= $this->organizationName ?> " href="<?= $this->orgProfileUrl($org)?>?clear=1"><?= $orgName ?></a>
                                                        <?php else: ?>
                                                            <strong><?= (!empty($this->organizationName)) ? $this->organizationName : $orgName ?></strong>
                                                        <?php endif ?>
                                                        <!-- end company name -->
                                                    </li>
                                                    <li class="type">
                                                        <!-- type of contract -->
                                                        <?php
                                                        $typeOfContract = $job->getClassifications()->getEmploymentTypes()->__toString() ?:'Vollzeit' ?>
                                                        <span class="yk-contract yk-<?=$typeOfContract?>"><?=$typeOfContract; ?></span>
                                                        <!-- end type of contract -->
                                                    </li>
                                                    <li class="date">
                                                        <!-- published date -->
                                                        <span><?= $this->publishDateFormatter($job) ?></span>
                                                        <!-- end published date -->
                                                    </li>
                                                    <!-- HINT: some jobs has invalid industries, therefore check for empty string -->
                                                    <?php if ($industries->getItems()->count() && !$this->isCrawlerJob($org) && $industries->__toString() != ""): ?>
                                                        <li class="industries">
                                                            <?= $industries->__toString(); ?>
                                                        </li>
                                                    <?php endif; ?>
                                                </ul>
                                                <div class="wrapper__right">
                                                    <div class="wrapper__logo">
                                                        <?php
                                                            $logoUrl = null;
                                                            if (is_object($org) && is_object($org->getImage()) && $org->getImage()->getUri()) {
                                                                $logoUrl = $this->basePath($this->organizationImageCache->getUri($org->getImage(true)));
                                                            }
                                                            if ($template && ($logo = $template->getLogo())) {
                                                                $logoUrl = $this->basePath($logo->getUri());
                                                            }
                                                        ?>
                                                        <?php if(!$jobHasExternLink) : ?>
                                                            <a title="<?=strip_tags($job->getTitle())?>" target="_blank"
                                                               href="<?=$href?>">
                                                                <img src="<?= $logoUrl ? $logoUrl : $defaultLogoUrl ?>" alt="<?= $orgName ?>">
                                                            </a>
                                                        <?php else : ?>
                                                            <img src="<?= $logoUrl ? $logoUrl : $defaultLogoUrl ?>" alt="<?= $orgName ?>">
                                                        <?php endif; ?>

                                                    </div>
                                                </div>
                                            </div>

                                            <p class="preview-text">
                                                <?php
                                                    $preview = null;
                                                    if ($job->getTemplateValues()->getIntroduction()) {
                                                        $preview = substr(strip_tags($job->getTemplateValues()->getIntroduction()), 0 , 250);
                                                    }
                                                    elseif ($job->getTemplateValues()->getHtml()) {
                                                        $preview = substr(strip_tags($job->getTemplateValues()->getHtml()), 0 , 250);
                                                    }
                                                    if ($preview) {
                                                        $preview = str_replace('<p>', '', $preview);
                                                        $preview = str_replace('</p>', '', $preview);
                                                        $preview .= ' ...';
                                                    }
                                                ?>
                                                <?= $preview?>
                                            </p>

                                            <div class="box__action-buttons">
                                                <!-- share button -->
                                                <?php if(!$jobHasExternLink) : ?>
                                                    <div id="shareMail<?= $index ?>" class="hidden-xs shareMail"
                                                         data-url="<?=$href?>" data-title="<?=strip_tags($job->getTitle())?>"></div>
                                                    <div id="shareWhatsapp<?= $index ?>" class="visible-xs shareWhatsapp"
                                                         data-url="<?=$href?>" data-title="<?=strip_tags($job->getTitle())?>"></div>
                                                <?php endif; ?>
                                                <!-- end share button -->

                                                <?php if(!$jobHasExternLink) : ?>
                                                    <!-- favorite button -->
                                                    <?php if (isset($savedJobsContainer->jobs[$job->getId()])) : ?>
                                                        <button type="button" class="btn btn-default saved"
                                                                data-text-saved="<?=$this->translate('Marked')?>" data-text-save="<?=$this->translate('Mark')?>">
                                                            <span><?=$this->translate('Marked')?></span>
                                                        </button>
                                                    <?php else : ?>
                                                        <button type="button" class="btn btn-default"
                                                                data-text-saved="<?=$this->translate('Marked')?>" data-text-save="<?=$this->translate('Mark')?>">
                                                            <span><?=$this->translate('Mark')?></span>
                                                        </button>
                                                    <?php endif ?>
                                                    <!-- end favorite button -->
                                                <?php endif; ?>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <?php if ($index == 1) : ?>
                                <!-- box after second job -->
                                <div class="g-ads"></div>
                            <?php endif ?>
                            <?php if ($index == 2) : ?>
                                <!-- box after third job -->
                                <div class="jobmail-form-2"></div>
                            <?php endif ?>
                        <?php endforeach?>
                    </div>
                </div>

                <!-- pagination -->
                <?= $this->paginationControl($jobs, 'Sliding', 'pagination-control', ['lang' => $this->params('lang'), 'route' => 'lang/jobboard']); ?>
                <!-- end pagination -->

                <!-- similar jobs -->
                <div class="similiar-jobs-landingpages">
                    <?php $parts=preg_split('~<!--more-->~' , $description);?>
                    <?php if (isset($parts[1]) && "" != trim($parts[1])): ?>
                        <?= $parts[1] ?>
                        <?php if (51 == $query): echo $this->landingpages(); endif; ?>
                    <?php endif ?>
                </div>
                <!-- end similar jobs -->
            </div>
            <?=$hasFacets ? '</div>' : '' ?>
        <?php endif ?>
        </div>
    </div>
</div>

<?php
    $queryGet = $this->params()->fromQuery();
    $hasPartTwo = (isset($parts[2]) && "" != trim($parts[2]));
    $searchTerm = (isset($queryGet['q']) && is_string($queryGet['q'])) ? trim($queryGet['q'],'"') : null;
    $hasRegion= isset($queryGet['region_MultiString']);
?>
<?php if (($searchTerm && $hasPartTwo) || ($hasRegion && $hasPartTwo)): ?>
<div class="col-md-12 job-overview-description-container">
    <div class="col-md-12 content">
        <div class="content__inner">
             <!-- title searchterm -->
            <?php $parts=preg_split('~<!--more-->~' , $description);?>
            <?php if ($hasPartTwo): ?>
                <?= $parts[2] ?>
            <?php endif ?>
            <!-- end title searchterm -->
            <!-- additional infos -->
            <?php $parts=preg_split('~<!--more-->~' , $description);?>
            <?php if (isset($parts[3]) && "" != trim($parts[3])): ?>
                <?= $parts[3] ?>
            <?php endif ?>
             <!-- end additional infos -->
        </div>
    </div>
</div>
<?php endif ?>






