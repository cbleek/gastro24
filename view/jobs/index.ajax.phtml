<?php
/**
 * YAWIK
 *
 * @filesource
 * @copyright (c) 2013 - 2016 Cross Solution (http://cross-solution.de)
 * @license   MIT
 */

// We only want to render something, if there are items.
if (count($jobs)): ?>
    <div class="hidden" id="update-job-count">
        <?=$this->jobs->getTotalItemCount()?>
    </div>

    <?php
        $hasFacets = $jobs instanceof \Solr\FacetsProviderInterface;
        $queryGet = $this->params()->fromQuery();
        unset($queryGet['clear']);
        $query = $this->params()->fromRoute('wpId') ?: (count($queryGet) ? 0 : 304);
        $wordpress = $this->proxy('wordpress');
        $searchTerm = (isset($queryGet['q']) && is_string($queryGet['q'])) ? trim($queryGet['q'],'"') : null;
        $hasRegion= isset($queryGet['region_MultiString']);
        $hasCity= isset($queryGet['city_MultiString']);
        //$breadcrumbText = $options->$text;
        $dateFilterValue = isset($queryGet['dateFilter']) ? $queryGet['dateFilter'] : '';

        $this->headMeta()->setName('description', $wordpress->chain(['page' => $query, 'value' => 'meta-fields.description'], ''));
        $this->headScript()->appendFile($this->basePath($this->asset('modules/Gastro24/jssocials-1.4.0/dist/jssocials.js')));
        $description = $wordpress->call('value', ['content.rendered'], '');
        $wordpressTitle = '';

        if ($this->params()->fromRoute('isLandingPage')) {
            $wordpressTitle = $wordpress->call('value', ['title.rendered'], '');
            $descriptionText = 'Aktuell ' . $this->jobs->getTotalItemCount() . ' verfügbare ' .
                $wordpressTitle . ' finden auf Gastrojob24.ch, der #1 Gastronomie & Hotellerie Jobbörse der Schweiz.';
            if ($this->jobs->getTotalItemCount() == 1) {
                $descriptionText = 'Aktuell ' . $this->jobs->getTotalItemCount() . ' verfügbaren ' .
                    $wordpressTitle . ' finden auf Gastrojob24.ch, der #1 Gastronomie & Hotellerie Jobbörse der Schweiz.';
            }


            $titleOgText = $this->jobs->getTotalItemCount() . ' ' . $wordpressTitle . ' verfügbar - Gastrojob24.ch.';
            $descriptionOgText = 'Jetzt Traumjob finden aus ' . $this->jobs->getTotalItemCount() . ' ' . $wordpressTitle . ' bei Gastrojob24.ch - der Gastronomie & Hotellerie Jobbörse der Schweiz.';
            $this->headMeta()->setName('description', $descriptionText)
                ->setProperty('og:title', $titleOgText)
                ->setProperty('og:description', $descriptionOgText)
                ->setProperty('og:url', 'https://www.gastrojob24.ch' . $this->url('lang/landingPage', ['q' => $this->params()->fromRoute('term'), 'format' => 'html'], true))
                ->setProperty('og:image', 'https://www.gastrojob24.ch/modules/Gastro24/gastro-logo-fb.png')
                ->setProperty('og:locale', 'de_DE')
                ->setProperty('og:type', 'website')
                ->setAutoEscape(false);
        }

        $container = new \Zend\Session\Container('gastro24_jobboardcontainer');
        $container->fromCompanyProfile = false;
        $container->searchTerm = $searchTerm;

        $savedJobsContainer = new \Zend\Session\Container('gastro24_savedjobs');
        $defaultLogoUrl = $this->basePath('modules/Gastro24/images/no-company-logo.png');
        $jobsRepo = $this->services('repositories')->get('Jobs');
    ?>
    <?php if ($hasFacets):
        if ($this->params()->fromRoute('isLandingPage')):?>
            <span class="facets-url" data-url="<?=$this->url('lang/landingPage', ['q' => $this->params()->fromRoute('term'), 'format' => 'html'], true)?>"></span>
        <?php endif;
        $facets = $jobs->getFacets();
        $activeFacets = $facets->getActiveValues();
    ?>
<?php endif;?>

<div class="row">
    <div class="col-md-12">

        <!-- breadcrumbs -->
        <?= $this->partial('jobs/partials/breadcrumbs.phtml', [
            'searchTerm' => $searchTerm,
            'hasRegion' => $hasRegion,
            'hasCity' => $hasCity,
            //'breadcrumbText' => $breadcrumbText,
            'wordpressTitle' => $wordpressTitle
        ]); ?>
        <!-- breadcrumbs -->

        <div class="page-title">
             <span><?=$this->jobs->getTotalItemCount() ?> </span>
            <h1><?=$wordpress->call('value', ['title.rendered'], '') ?: (count($this->jobs) ? 'Treffer für '.$searchTerm.' Jobs' : 'Leider keine passenden Jobs gefunden'); ?></h1>
        </div>

        <div class="row job-results-container">
            <div class="col-md-12 container__date-filter">

                <div class="container--filter">
                    <span class="filter-icon <?= ($activeFacets) ? 'active' : '' ?>">
                        <a data-toggle="collapse" href="#facets-container" aria-expanded="false" aria-controls="facets-container">
                            <i class="fa fa-sliders" aria-hidden="true"></i>
                        </a>
                    </span>
                    <div class="container--date-picker">
                        <div style="margin-right: 10px;">Erscheinungsdatum</div>
                        <!-- date filter -->
                        <?= $this->partial('jobs/partials/date-filter-select.phtml', [
                            'dateFilterValue' => $dateFilterValue,
                            'facets' => $facets,
                        ]); ?>
                    </div>
                    <!-- end date filter -->
                </div>
            </div>
     <div class="col-md-3 container--facets dont-collapse-sm collapse <?= ($activeFacets) ? 'in' : '' ?>"
          aria-expanded="<?= ($activeFacets) ? 'true' : 'false' ?>" id="facets-container">
        <!-- list active filters -->
        <?php if ($activeFacets):?>
            <div class="well well-sm">
                <?php foreach ($activeFacets as $facetName => $facetValues):?>
                    <?php foreach ($facetValues as $facetValue):?>
                        <button type="button" class="btn btn-primary btn-sm facet-active" data-name="<?=$this->escapeHtmlAttr($facetName)?>[<?=$this->escapeHtmlAttr($facetValue)?>]" title="<?=$this->translate('Remove filter')?>"><?=$facetValue?> <span>&times;</span></button>
                    <?php endforeach;?>
                <?php endforeach;?>

                <p>Sie können Ihre Jobsuche weiter einschränken, indem Sie unten ein oder mehrere Filterkriterien auswählen.</p>
                <button type="button" class="btn btn-link facet-reset"><?=$this->translate('Remove all filters')?></button>
            </div>
        <?php endif;?>
        <!-- end list active filters -->
        
         <!-- filter -->
        <div class="panel-group">
                <?php $facetsHtml = ''; $isFirstFacet = true; $atLeastOneTotalActive = false; foreach ($facets as $facetName => $facetValues):?>
                <?php $facetOptionsCounter = 0; ?>
                <?php if($facetName == 'datePublishStart') continue; ?>
                <?php if(count($facetValues)>0): $atLeastOneActive = false; $facetsList = []; ob_start();?>
                <div id="facets-box-<?=$facetName?>" class="panel panel-default">
                    <div class="panel-heading">
                        <a class="facets-heading-<?=$facetName?> <?=$isFirstFacet ?  '%firstCollapsed% ' : '%collapsed%'?>" data-toggle="collapse" data-parent="#facets-box-<?=$facetName?>" href="#facets-box-<?=$facetName?>-content">
                        <?=$this->translate($facets->getTitle($facetName))?>
                             <span class="fa fa-chevron-down"></span>
                        </a>

                    </div>
                    <div id="facets-box-<?=$facetName?>-content" class="panel-collapse collapse <?=$isFirstFacet ? '%firstIn%' : '%in%' ?>">
                    <div class="panel-body">
                        <?php foreach ($facetValues as $facetValue => $facetValueCount):
                            $facetOptionsCounter++;
                            if($facetOptionsCounter > 10) continue;
                            $activeFacet = $facets->isValueActive($facetName, $facetValue);
                            $atLeastOneActive = $atLeastOneActive || $activeFacet;?>
                            <div class="filter-links">
                                <label<?=$activeFacet ? ' class="text-primary"' : ''?>>  <?=$activeFacet ? ' <i class="fa fa-check"></i>' : ''?>
                                    <input type="checkbox" name="<?=$this->escapeHtmlAttr($facetName)?>[<?=$this->escapeHtmlAttr($facetValue)?>]"
                                           class="facet-checkbox"<?=$activeFacet?" checked":""?>>
                                    <?=$facetValue?> <span class="filter-count"><?=$facetValueCount?></span>
                                </label>
                            </div>
                        <?php if ($activeFacet): $facetsList[] = $facetValue; endif; endforeach;?>
                    </div>
                    </div> <!-- facets-collaps-* -->
                </div>
                <?php $facetsHtml .= str_replace(
                        ['%in%', '%firstIn%', '%firstCollapsed%', '%collapsed%', '%facetsList%' ],
                        [
                                $atLeastOneActive ? 'in' : '',
                                $atLeastOneActive ? 'in' : '%firstIn%',
                                $atLeastOneActive ? '' : '%firstCollapsed%',
                                $atLeastOneActive ? '' : 'collapsed',
                                join(', ', $facetsList),
                        ],
                        ob_get_clean()
                    ); $atLeastOneTotalActive = $atLeastOneTotalActive || $atLeastOneActive; endif; $isFirstFacet = false;?>
            <?php endforeach;
                echo str_replace(
                        ['%firstCollapsed%', '%firstIn%'],
                        [$atLeastOneTotalActive ? 'collapsed' : '', $atLeastOneTotalActive ? '' : 'in'],
                        $facetsHtml
                );
            ?>
        </div>
       </div>
            <!-- result list -->
            <div class="col-md-9 job-overview-results">
                <div class="row">
                    <div class="row-eq-height">
                        <?php
                            // get date difference
                            $today = new DateTime();
                        ?>
                        <?php foreach ($jobs as $index => $job): ?>
                            <?php
                                $org = $job->getOrganization();
                                $hasJobTemplate = $this->gastroJobTemplate($org);
                                $isIntern = (!$job->getLink() || $hasJobTemplate);
                                $isEmbeddable = $this->gastroIsEmbeddable($job->getLink());
                                $jobHasExternLink = (!$isIntern && !$isEmbeddable);
                                $industries = $job->getClassifications()->getIndustries();
                                $orgName = $this->jobOrganizationName($job);

                                // TODO: remove workaround with repo after yawik/solr Update
                                $jobObject = $jobsRepo->find($job->getId());
                                $template = $jobObject->getAttachedEntity('gastro24-template');

                                $isExpired = ($job->getStatus()) ? $job->getStatus()->getName() == \Jobs\Entity\StatusInterface::EXPIRED : false;
                                $orgIsDisabled = false;
                                if ($org && (Organizations\Entity\Organization::PROFILE_DISABLED == $org->getProfileSetting() || is_null($org->getProfileSetting())) ) {
                                    $orgIsDisabled = true;
                                }
                                $href = ($jobHasExternLink) ? $job->getLink() : $this->jobUrl($job, ['linkOnly' => true, 'absolute' => true ]);
                            ?>
                            <div class="col-md-12 col-sm-6 col-xs-12">
                                <div class="featured-image-box">
                                    <?php
                                        // check for newer than 24 hoursj
                                        $jobDate = $job->getDatePublishStart() ?? $job->getDateCreated();
                                        $dayDiff = $today->diff($jobDate);
                                        if ($dayDiff->days < 1) {
                                            echo '<div class="corner"><span>NEU</span></div>';
                                        }
                                    ?>

                                    <div class="content-area">
                                        <div class="top-cnt">
                                            <div class="box__job-favorite">
                                                <h2>
                                                    <?php if($jobHasExternLink) { ?>
                                                        <a title="<?=strip_tags($job->getTitle())?>" rel="nofollow noopener sponsored" target="_blank"
                                                           href="<?=$href?>"><?=strip_tags($job->getTitle())?>
                                                           <i class="fa fa-external-link"></i>
                                                        </a>
                                                    <?php }
                                                    else { ?>
                                                        <a title="<?=strip_tags($job->getTitle())?>"
                                                           href="<?=$href?>"><?=strip_tags($job->getTitle())?>
                                                        </a>
                                                    <?php } ?>
                                                </h2>
                                            </div>
                                            <div class="box__job-short-info">
                                                <ul>
                                                    <li class="location">
                                                        <!-- location -->
                                                        <?php
                                                        $location = $job->getLocations()->last();
                                                        if ($location == '') {
                                                            $locationString = $this->translate('Swiss');
                                                        }
                                                        elseif ($location) {
                                                            $locationString = $location->getCity() ? $location->getCity() :
                                                                preg_replace('~\(.*?\)$~', '', (string) $job->getLocation());
                                                        }
                                                        else {
                                                            $locationString = preg_replace('~\(.*?\)$~', '', (string) $job->getLocation());
                                                        }
                                                        ?>
                                                        <?=$locationString ?>
                                                        <!-- end location -->
                                                    </li>
                                                    <li class="company">
                                                        <!-- company name -->
                                                        <?php if ($org && !$orgIsDisabled): ?>
                                                            <a title="Jobs <?= $this->organizationName ?> " href="<?= $this->orgProfileUrl($org)?>?clear=1"><?= $orgName ?></a>
                                                        <?php else: ?>
                                                            <strong><?= (!empty($this->organizationName)) ? $this->organizationName : $orgName ?></strong>
                                                        <?php endif ?>
                                                        <!-- end company name -->
                                                    </li>
                                                    <li class="type">
                                                        <!-- type of contract -->
                                                        <?php
                                                        $typeOfContract = $job->getClassifications()->getEmploymentTypes()->__toString() ?:'Vollzeit' ?>
                                                        <span class="yk-contract yk-<?=$typeOfContract?>"><?=$typeOfContract; ?></span>
                                                        <!-- end type of contract -->
                                                    </li>
                                                    <li class="date">
                                                        <!-- published date -->
                                                        <span><?= $this->publishDateFormatter($job) ?></span>
                                                        <!-- end published date -->
                                                    </li>
                                                    <!-- HINT: some jobs has invalid industries, therefore check for empty string -->
                                                    <?php if ($industries->getItems()->count() && !$this->isCrawlerJob($org) && $industries->__toString() != ""): ?>
                                                        <li class="industries">
                                                            <?= $industries->__toString(); ?>
                                                        </li>
                                                    <?php endif; ?>
                                                </ul>
                                                <div class="wrapper__right">
                                                    <div class="wrapper__logo">
                                                        <?php
                                                            $logoUrl = null;
                                                            if (is_object($org) && is_object($org->getImage()) && $org->getImage()->getUri()) {
                                                                $logoUrl = $this->basePath($this->organizationImageCache->getUri($org->getImage(true)));
                                                            }
                                                            if ($template && ($logo = $template->getLogo())) {
                                                                $logoUrl = $this->basePath($logo->getUri());
                                                            }
                                                        ?>
                                                        <?php if(!$jobHasExternLink) : ?>
                                                            <a title="<?=strip_tags($job->getTitle())?>" target="_blank"
                                                               href="<?=$href?>">
                                                                <img loading="lazy" src="<?= $logoUrl ? $logoUrl : $defaultLogoUrl ?>" alt="<?= $orgName ?>" />
                                                            </a>
                                                        <?php else : ?>
                                                            <img loading="lazy" src="<?= $logoUrl ? $logoUrl : $defaultLogoUrl ?>" alt="<?= $orgName ?>" />
                                                        <?php endif; ?>

                                                    </div>
                                                </div>
                                          </div>

                                   <div class="row">
                                       <div class="col-xs-12 col-md-10">
                                            <p class="preview-text">
                                               
                                                <?php
                                                    $preview = null;
                                                    if ($job->getTemplateValues()->getIntroduction()) {
                                                        $preview = substr(strip_tags($job->getTemplateValues()->getIntroduction()), 0 , 215);
                                                    }
                                                    elseif ($job->getTemplateValues()->getHtml()) {
                                                        $preview = $job->getTemplateValues()->getHtml();
                                                        $preview = str_replace(['<li>', '</p>', '</h2>', '<b>', '</b>', '<br>', '</h4>','</h3>','</span>','<span>','<div>'], ' ', $preview);
                                                        $preview = substr(strip_tags($preview), 0 , 215);
                                                    }
                                                    if ($preview) {
                                                        $preview = str_replace('<p>', '', $preview);
                                                        $preview = str_replace('</p>', '', $preview);
                                                        $preview   = implode(' ', explode(' ', $preview, -1));
                                                        $preview .= ' ... ';
                                                    }
                                                ?>
                                                <?= $preview ?>
   
                                            </p>
                                        </div>
                                    <div class="col-xs-12 col-md-2">
                                        
                                         <div class="box__action-buttons">
                                                <!-- share button -->
                                                <?php if(!$jobHasExternLink) : ?>
                                                    <div id="shareMail<?= $index ?>" class="hidden shareMail"
                                                         data-url="<?=$href?>" data-title="<?=strip_tags($job->getTitle())?>"></div>
                                                    <div id="shareWhatsapp<?= $index ?>" class="visible-sm visible-xs shareWhatsapp"
                                                         data-url="<?=$href?>" data-title="<?=strip_tags($job->getTitle())?>"></div>
                                                <?php endif; ?>
                                                <!-- end share button -->

                                                <?php if(!$jobHasExternLink) : ?>
                                                    <!-- favorite button -->
                                                    <?php if (isset($savedJobsContainer->jobs[$job->getId()])) : ?>
                                                        <button type="button" class="btn btn-default saved"
                                                                data-text-saved="<?=$this->translate('Marked')?>" data-text-save="<?=$this->translate('Mark')?>">
                                                            <span><?=$this->translate('Marked')?></span>
                                                        </button>
                                                    <?php else : ?>
                                                        <button type="button" class="pull-right btn btn-default"
                                                                data-text-saved="<?=$this->translate('Marked')?>" data-text-save="<?=$this->translate('Mark')?>">
                                                            <span><?=$this->translate('Mark')?></span>
                                                        </button>
                                                    <?php endif ?>
                                                    <!-- end favorite button -->
                                                <?php endif; ?>
                                            </div>

                                   </div>
                                  </div>

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <?php if ($index == 1) : ?>
                                <!-- box after second job -->
                               <div id="form-jobsbymail-subscribe-form" class="form-jobsbymail-subscribe-form-desktop col-md-12 col-sm-6 col-xs-12">
                                    <div class="featured-image-box">
                                        <h2>Täglich neue Jobs per E-Mail erhalten?</h2>
                                        <p>Lassen Sie sich automatisch informieren, sobald für dieses Suchergebnis neue Stellen online sind.</p>
                                        <?=$this->proxy('jobsByMailSubscriptionForm')->render($jobs)?>
                                    </div>
                                </div>
                            <?php endif ?>
                            <?php if ($index == 2) : ?>
                                <!-- box after third job -->

                            <?php endif ?>
                        <?php endforeach?>
                    </div>
                </div>
             
                <!-- pagination -->
                   <?= $this->paginationControl($jobs, 'Sliding', 'pagination-control', ['lang' => $this->params('lang'), 'route' => 'lang/jobboard']); ?>
                <!-- end pagination -->
                

                <?php $parts=preg_split('~<!--more-->~' , $description);?>
                <?php if (isset($parts[1]) && "" != trim($parts[1])): ?>
							<div class="row">
                              <div class="col-md-12" id="infobox-<?=$this->params()->fromRoute('term') ?>">
                                <div class="featured-image-box similarjob">
                                   <?= $parts[1] ?>
                                    <?php if (51 == $query): echo $this->landingpages(); endif; ?>
                                    
                                    </div>
                                 </div>
								</div>
                 <?php endif ?>
                
            </div>
            <?=$hasFacets ? '</div>' : '' ?>
<?php endif ?>

 <?php if (count($this->jobs)):?>
 
         <div class="row">
            <div class="col-md-12">
                <div class="to-top-link">
                    <a id="scroll-to-top" href="#top"><span class="fa fa-chevron-up"></span> nach oben</a>
                </div>
            </div>
          </div>
         
        
   <?php endif ?>
 
        </div>
    </div>
</div>

<?php
    $queryGet = $this->params()->fromQuery();
    $hasPartTwo = (isset($parts[2]) && "" != trim($parts[2]));
    $searchTerm = (isset($queryGet['q']) && is_string($queryGet['q'])) ? trim($queryGet['q'],'"') : null;
    $hasRegion= isset($queryGet['region_MultiString']);
    $hasCity= isset($queryGet['city_MultiString']);
?>